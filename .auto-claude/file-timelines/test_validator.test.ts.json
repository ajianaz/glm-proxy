{
  "file_path": "test/validator.test.ts",
  "main_branch_history": [],
  "task_views": {
    "006-implement-in-memory-api-key-cache-with-ttl-to-elim": {
      "task_id": "006-implement-in-memory-api-key-cache-with-ttl-to-elim",
      "branch_point": {
        "commit_hash": "e4ccb2c239067a08687940247e7dc3c37228e546",
        "content": "import { describe, it, expect, vi } from 'vitest';\nimport { validateApiKey, getModelForKey } from '../src/validator.js';\nimport type { ApiKey } from '../src/types.js';\n\n// Mock storage functions\nvi.mock('../src/storage.js', () => ({\n  findApiKey: async (key: string) => {\n    if (key === 'pk_valid_key') {\n      return {\n        key: 'pk_valid_key',\n        name: 'Test User',\n        model: 'glm-4.7',\n        token_limit_per_5h: 100000,\n        expiry_date: '2026-12-31T23:59:59Z',\n        created_at: '2026-01-18T00:00:00Z',\n        last_used: '2026-01-18T00:00:00Z',\n        total_lifetime_tokens: 0,\n        usage_windows: [],\n      } as ApiKey;\n    }\n    if (key === 'pk_expired_key') {\n      return {\n        key: 'pk_expired_key',\n        name: 'Expired User',\n        model: 'glm-4.7',\n        token_limit_per_5h: 100000,\n        expiry_date: '2024-01-01T00:00:00Z',\n        created_at: '2023-01-18T00:00:00Z',\n        last_used: '2023-01-18T00:00:00Z',\n        total_lifetime_tokens: 0,\n        usage_windows: [],\n      } as ApiKey;\n    }\n    return null;\n  },\n}));\n\ndescribe('Validator', () => {\n  describe('validateApiKey', () => {\n    it('should return valid for existing non-expired key', async () => {\n      const result = await validateApiKey('Bearer pk_valid_key');\n      expect(result.valid).toBe(true);\n      expect(result.apiKey).toBeDefined();\n      expect(result.error).toBeUndefined();\n    });\n\n    it('should return invalid for expired key', async () => {\n      const result = await validateApiKey('Bearer pk_expired_key');\n      expect(result.valid).toBe(false);\n      expect(result.error).toContain('expired');\n      expect(result.statusCode).toBe(403);\n    });\n\n    it('should return invalid for missing key', async () => {\n      const result = await validateApiKey(undefined);\n      expect(result.valid).toBe(false);\n      expect(result.error).toContain('required');\n      expect(result.statusCode).toBe(401);\n    });\n\n    it('should return invalid for invalid key', async () => {\n      const result = await validateApiKey('Bearer pk_invalid_key');\n      expect(result.valid).toBe(false);\n      expect(result.error).toBe('Invalid API key');\n      expect(result.statusCode).toBe(401);\n    });\n  });\n\n  describe('getModelForKey', () => {\n    it('should return model from API key', () => {\n      const key: ApiKey = {\n        key: 'pk_test',\n        name: 'Test',\n        model: 'glm-4.7',\n        token_limit_per_5h: 100000,\n        expiry_date: '2026-12-31T23:59:59Z',\n        created_at: '2026-01-18T00:00:00Z',\n        last_used: '2026-01-18T00:00:00Z',\n        total_lifetime_tokens: 0,\n        usage_windows: [],\n      };\n      const model = getModelForKey(key);\n      expect(model).toBe('glm-4.7');\n    });\n\n    it('should return default model when key has no model', () => {\n      const key: ApiKey = {\n        key: 'pk_test',\n        name: 'Test',\n        model: '',\n        token_limit_per_5h: 100000,\n        expiry_date: '2026-12-31T23:59:59Z',\n        created_at: '2026-01-18T00:00:00Z',\n        last_used: '2026-01-18T00:00:00Z',\n        total_lifetime_tokens: 0,\n        usage_windows: [],\n      };\n      const model = getModelForKey(key);\n      expect(model).toBe('glm-4.7'); // DEFAULT_MODEL fallback\n    });\n  });\n});\n",
        "timestamp": "2026-01-22T13:20:55.122162"
      },
      "worktree_state": {
        "content": "import { describe, it, expect, beforeEach, afterAll } from 'vitest';\nimport { validateApiKey, getModelForKey } from '../src/validator.js';\nimport { writeApiKeys } from '../src/storage.js';\nimport type { ApiKey } from '../src/types.js';\nimport { existsSync, unlinkSync } from 'fs';\nimport { join } from 'path';\n\n// Mock DATA_FILE environment variable for tests\nconst TEST_FILE = join(process.cwd(), 'data', 'test-validator.json');\n\n// Save original DATA_FILE\nconst originalDataFile = process.env.DATA_FILE;\n\nconst validKey: ApiKey = {\n  key: 'pk_valid_key',\n  name: 'Test User',\n  model: 'glm-4.7',\n  token_limit_per_5h: 100000,\n  expiry_date: '2026-12-31T23:59:59Z',\n  created_at: '2026-01-18T00:00:00Z',\n  last_used: '2026-01-18T00:00:00Z',\n  total_lifetime_tokens: 0,\n  usage_windows: [],\n};\n\nconst expiredKey: ApiKey = {\n  key: 'pk_expired_key',\n  name: 'Expired User',\n  model: 'glm-4.7',\n  token_limit_per_5h: 100000,\n  expiry_date: '2024-01-01T00:00:00Z',\n  created_at: '2023-01-18T00:00:00Z',\n  last_used: '2023-01-18T00:00:00Z',\n  total_lifetime_tokens: 0,\n  usage_windows: [],\n};\n\ndescribe('Validator', () => {\n  beforeEach(async () => {\n    // Set test data file\n    process.env.DATA_FILE = TEST_FILE;\n\n    // Clean up test file\n    if (existsSync(TEST_FILE)) {\n      unlinkSync(TEST_FILE);\n    }\n\n    // Write test keys\n    await writeApiKeys({ keys: [validKey, expiredKey] });\n  });\n\n  afterAll(() => {\n    // Restore original DATA_FILE\n    process.env.DATA_FILE = originalDataFile;\n\n    // Clean up test file\n    if (existsSync(TEST_FILE)) {\n      unlinkSync(TEST_FILE);\n    }\n  });\n  describe('validateApiKey', () => {\n    it('should return valid for existing non-expired key', async () => {\n      const result = await validateApiKey('Bearer pk_valid_key');\n      expect(result.valid).toBe(true);\n      expect(result.apiKey).toBeDefined();\n      expect(result.error).toBeUndefined();\n    });\n\n    it('should return invalid for expired key', async () => {\n      const result = await validateApiKey('Bearer pk_expired_key');\n      expect(result.valid).toBe(false);\n      expect(result.error).toContain('expired');\n      expect(result.statusCode).toBe(403);\n    });\n\n    it('should return invalid for missing key', async () => {\n      const result = await validateApiKey(undefined);\n      expect(result.valid).toBe(false);\n      expect(result.error).toContain('required');\n      expect(result.statusCode).toBe(401);\n    });\n\n    it('should return invalid for invalid key', async () => {\n      const result = await validateApiKey('Bearer pk_invalid_key');\n      expect(result.valid).toBe(false);\n      expect(result.error).toBe('Invalid API key');\n      expect(result.statusCode).toBe(401);\n    });\n  });\n\n  describe('validateApiKey', () => {\n    it('should return valid for existing non-expired key', async () => {\n      const result = await validateApiKey('Bearer pk_valid_key');\n      expect(result.valid).toBe(true);\n      expect(result.apiKey).toBeDefined();\n      expect(result.error).toBeUndefined();\n    });\n\n    it('should return invalid for expired key', async () => {\n      const result = await validateApiKey('Bearer pk_expired_key');\n      expect(result.valid).toBe(false);\n      expect(result.error).toContain('expired');\n      expect(result.statusCode).toBe(403);\n    });\n\n    it('should return invalid for missing key', async () => {\n      const result = await validateApiKey(undefined);\n      expect(result.valid).toBe(false);\n      expect(result.error).toContain('required');\n      expect(result.statusCode).toBe(401);\n    });\n\n    it('should return invalid for invalid key', async () => {\n      const result = await validateApiKey('Bearer pk_invalid_key');\n      expect(result.valid).toBe(false);\n      expect(result.error).toBe('Invalid API key');\n      expect(result.statusCode).toBe(401);\n    });\n  });\n\n  describe('getModelForKey', () => {\n    it('should return model from API key', () => {\n      const key: ApiKey = {\n        key: 'pk_test',\n        name: 'Test',\n        model: 'glm-4.7',\n        token_limit_per_5h: 100000,\n        expiry_date: '2026-12-31T23:59:59Z',\n        created_at: '2026-01-18T00:00:00Z',\n        last_used: '2026-01-18T00:00:00Z',\n        total_lifetime_tokens: 0,\n        usage_windows: [],\n      };\n      const model = getModelForKey(key);\n      expect(model).toBe('glm-4.7');\n    });\n\n    it('should return default model when key has no model', () => {\n      const key: ApiKey = {\n        key: 'pk_test',\n        name: 'Test',\n        model: '',\n        token_limit_per_5h: 100000,\n        expiry_date: '2026-12-31T23:59:59Z',\n        created_at: '2026-01-18T00:00:00Z',\n        last_used: '2026-01-18T00:00:00Z',\n        total_lifetime_tokens: 0,\n        usage_windows: [],\n      };\n      const model = getModelForKey(key);\n      expect(model).toBe('glm-4.7'); // DEFAULT_MODEL fallback\n    });\n  });\n});\n",
        "last_modified": "2026-01-22T13:20:55.585978"
      },
      "task_intent": {
        "title": "Implement in-memory API key cache with TTL to eliminate file I/O on every request",
        "description": "",
        "from_plan": false
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2026-01-22T12:46:07.715988",
  "last_updated": "2026-01-22T13:20:55.531581"
}